import{j as e,M as ue}from"./vendor-ui-Csmkvd-_.js";import{r as s,u as xe}from"./vendor-react-B11IQRCK.js";import{G as ge}from"./vendor-core-L0lX3Z62.js";import{p as me,a as fe,h as pe,J as te,b as se,X as M,L as he,g as ne,d as be,f as we}from"./index-K6Oge8P9.js";const G="AIzaSyAao48NBXbU0Kqwp8vJJl7J3I4vU4sRKO4";function ve(r){const i=atob(r),a=i.length,l=new Uint8Array(a);for(let c=0;c<a;c++)l[c]=i.charCodeAt(c);return l}function ye(r){let i="";const a=new Uint8Array(r),l=a.byteLength;for(let c=0;c<l;c++)i+=String.fromCharCode(a[c]);return btoa(i)}async function je(r,i,a,l){const c=new Int16Array(r.buffer),p=c.length/l,N=i.createBuffer(l,p,a);for(let d=0;d<l;d++){const L=N.getChannelData(d);for(let m=0;m<p;m++)m*l+d<c.length&&(L[m]=c[m*l+d]/32768)}return N}const oe={dashboard:"EstÃ¡s en el Dashboard Principal. Tienes visibilidad de los KPIs globales.",nc:"EstÃ¡s en el mÃ³dulo de No Conformidades. Puedes ayudar a analizar causas raÃ­z y redactar acciones correctivas.",forms:"EstÃ¡s en Formularios. Ayuda a verificar tolerancias y criterios de aceptaciÃ³n.",audits:"EstÃ¡s en AuditorÃ­as. Sugiere preguntas de auditorÃ­a basadas en ISO 9001.",projects:"EstÃ¡s en GestiÃ³n de Proyectos. Analiza cronogramas y riesgos."},Se=r=>{for(const i in oe)if(r.includes(i))return oe[i];return"EstÃ¡s en el menÃº principal."},ae=(r,i,a="Global")=>`
${`Eres "Agente Calidad", el Sistema Inteligente de Alco.CONTEXTO ACTUAL: ${Se(i)} `}

TU IDENTIDAD ACTIVA: ${{Global:`
ROL: Coordinador General de Calidad.
    OBJETIVO: VisiÃ³n holÃ­stica del sistema.
        ESTILO: Formal, directivo y estratÃ©gico.
`,Ops:`
ROL: Asistente de Operaciones y ProducciÃ³n.
    OBJETIVO: Resolver dudas tÃ©cnicas inmediatas en planta.
        ESTILO: PrÃ¡ctico, breve y tÃ©cnico. "Al grano".
            COMPETENCIAS: InterpretaciÃ³n de Planos, Tolerancias, Maquinaria.
`,QA:`
ROL: Auditor Senior de Calidad(QC / QA).
    OBJETIVO: DetecciÃ³n rigurosa de desviaciones.
        ESTILO: AnalÃ­tico, basado en evidencia y normativa ISO 9001 / ASTM.
`,Project:`
ROL: Gestor de Proyectos(PM).
    OBJETIVO: Control de cronograma y riesgos.
        ESTILO: Orientado a plazos y riesgos.
`,Supply:`
ROL: Analista de Proveedores y Compras.
    OBJETIVO: Aseguramiento de calidad de insumos.
        ESTILO: Negociador y detallista.
`}[a]}

CAPACIDADES GENERALES:
- ${r?"ACCESO ONLINE ACTIVADO: Valida datos en tiempo real.":"MODO OFFLINE: Responde con tu base de conocimiento interna."}
- MÃ‰TODO DE RESPUESTA: Usa Markdown.SÃ© conciso.Si detectas riesgo, inicia con[ALERTA].
- IDIOMA: Responde SIEMPRE en EspaÃ±ol, a menos que se solicite explÃ­citamente otro idioma para una traducciÃ³n.
`,Ce=()=>{const{isAgentOpen:r,toggleAgent:i,activeDocument:a,setActiveDocument:l}=me(),{addNotification:c}=fe(),[p,N]=s.useState("text"),[d,L]=s.useState(!0),[m,re]=s.useState("Global"),B=xe(),[y,U]=s.useState(""),[J,F]=s.useState(!1),[K,k]=s.useState([{id:"welcome",role:"agent",content:"Hola. Soy Agente Calidad v5.0. Analizo procesos, predigo riesgos y te asisto con la normativa. Â¿En quÃ© trabajamos hoy?"}]),[_,ie]=s.useState([]),[w,V]=s.useState(null),q=s.useRef(null),Q=s.useRef(null),I=s.useRef(0),W=s.useRef(null),H=s.useRef(null),$=s.useRef(null),j=s.useRef(new Set);s.useRef(null);const C=s.useRef(null),E=s.useRef(null),O=s.useRef(null),[R,z]=s.useState(!1),[T,S]=s.useState("disconnected"),D=s.useRef(null);s.useEffect(()=>{r&&Q.current?.scrollIntoView({behavior:"smooth"})},[K,r,p]);const ce=t=>{const n=t.target.files?.[0];if(n){const o=new FileReader;o.onload=A=>{const h=(A.target?.result).split(",")[1];V({data:h,mime:n.type})},o.readAsDataURL(n)}},X=async()=>{if(!y.trim()&&!w)return;const t={id:Date.now().toString(),role:"user",content:y};k(n=>[...n,t]),U(""),ie([]),F(!0);try{const n=new ge(G),o=[{text:y||"Analiza esta situaciÃ³n tÃ©cnica."}];a&&(o.push({inlineData:{data:a.content,mimeType:a.mime}}),o.unshift({text:`[SYSTEM] El usuario estÃ¡ visualizando el documento "${a.name}".Ãšsalo como contexto principal si es relevante.`})),w&&o.push({inlineData:{data:w.data,mimeType:w.mime}});const A=ae(d,B.pathname,m);let h="",u="gemini-1.5-flash-001";try{h=(await(await n.getGenerativeModel({model:"gemini-1.5-flash-001",systemInstruction:{parts:[{text:A}]},tools:d?[{googleSearch:{}}]:void 0}).generateContent(o)).response).text()}catch(x){console.warn("Flash failed, trying Pro:",x),u="gemini-1.5-pro-001",h=(await(await n.getGenerativeModel({model:"gemini-1.5-pro-001",systemInstruction:{parts:[{text:A}]},tools:d?[{googleSearch:{}}]:void 0}).generateContent(o)).response).text()}const b={id:(Date.now()+1).toString(),role:"agent",content:h||"He procesado tu solicitud."};k(x=>[...x,b]),V(null)}catch(n){console.error("AI Error:",n),k(o=>[...o,{id:"err",role:"agent",content:`âš ï¸ ** Error de Sistema **

${n.message||"Error desconocido"} 

 * DiagnÃ³stico:*
 - API Key: SÃ 
 - Modelo: gemini-1.5-flash/pro 
 - SDK: @google/generative-ai`}])}finally{F(!1)}},Y=()=>{D.current&&(D.current.close(),D.current=null),j.current?.forEach(t=>{try{t.stop()}catch{}}),j.current?.clear(),C.current&&(C.current.getTracks().forEach(t=>t.stop()),C.current=null),E.current&&(E.current.disconnect(),E.current=null),O.current&&(O.current.disconnect(),O.current=null),W.current?.close().catch(()=>{}),H.current?.close().catch(()=>{}),S("disconnected"),z(!1)},le=async()=>{try{S("connecting");const t=await navigator.mediaDevices.getUserMedia({audio:!0});C.current=t;const n=new(window.AudioContext||window.webkitAudioContext),o=new(window.AudioContext||window.webkitAudioContext)({sampleRate:24e3});W.current=n,H.current=o,$.current=o.createGain(),$.current.connect(o.destination);const h=`wss://generativelanguage.googleapis.com/ws/google.ai.generativelanguage.v1alpha.GenerativeService.BidiGenerateContent?key=${G}`,u=new WebSocket(h);D.current=u,u.onopen=()=>{S("connected");const b={setup:{model:"models/gemini-2.0-flash-exp",generationConfig:{responseModalities:["AUDIO"],speechConfig:{voiceConfig:{prebuiltVoiceConfig:{voiceName:"Puck"}}}},systemInstruction:{parts:[{text:ae(!1,B.pathname,m)}]}}};u.send(JSON.stringify(b));const x=n.createMediaStreamSource(t),f=n.createScriptProcessor(4096,1,1);f.onaudioprocess=v=>{const g=v.inputBuffer.getChannelData(0),Z=g.length,ee=new Int16Array(Z);for(let P=0;P<Z;P++)ee[P]=g[P]*32768;const de={realtime_input:{media_chunks:[{mime_type:"audio/pcm;rate=16000",data:ye(ee.buffer)}]}};u.readyState===WebSocket.OPEN&&u.send(JSON.stringify(de))},x.connect(f),f.connect(n.destination),E.current=f,O.current=x},u.onmessage=async b=>{try{const f=JSON.parse(b.data).serverContent?.modelTurn?.parts?.[0]?.inlineData?.data;if(f){z(!0);const v=await je(ve(f),o,24e3,1),g=o.createBufferSource();g.buffer=v,g.connect($.current),I.current=Math.max(I.current,o.currentTime),g.start(I.current),I.current+=v.duration,j.current.add(g),g.onended=()=>{j.current.delete(g),j.current.size===0&&z(!1)}}}catch(x){console.error("WS Message Parse Error",x)}},u.onerror=b=>{console.error("WebSocket Error:",b),S("disconnected"),c({type:"error",title:"Error de ConexiÃ³n",message:"FallÃ³ la conexiÃ³n de voz. Verifique su API Key o permisos de red."})},u.onclose=()=>{Y()}}catch(t){console.error("Voice Session Error:",t),S("disconnected"),k(n=>[...n,{id:"err_voice",role:"agent",content:`âš ï¸ **Error de Voz**

No se pudo conectar con el modo Live`}])}};return e.jsxs("div",{className:"fixed bottom-8 right-8 z-[1000] flex flex-col items-end gap-4",children:[r&&e.jsxs("div",{className:"bg-white dark:bg-[#1e1e2d] w-[400px] h-[600px] rounded-3xl shadow-2xl border border-slate-200 dark:border-white/5 flex flex-col overflow-hidden animate-fade-in-up origin-bottom-right",children:[e.jsxs("div",{className:"p-4 bg-gradient-to-r from-[#5d5fef] to-[#4f46e5] space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-white/20 p-2 rounded-xl backdrop-blur-md text-yellow-300",children:e.jsx(pe,{})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-black text-sm uppercase tracking-wide",children:"Agente Calidad"}),e.jsx("p",{className:"text-[10px] text-indigo-100 opacity-90 font-medium",children:T==="connected"?"ðŸŽ™ï¸ Voz Activa":"ðŸŸ¢ Sistema Online"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>L(!d),className:`text-[10px] font-bold px-2 py-1 rounded-lg transition-all border ${d?"bg-emerald-500/20 border-emerald-400 text-emerald-100":"bg-white/10 border-white/20 text-white/60"}`,title:"BÃºsqueda Web",children:e.jsx(te,{})}),e.jsx("button",{onClick:()=>N(p==="text"?"voice":"text"),className:`p-2 rounded-lg transition-all ${p==="voice"?"bg-white text-[#5d5fef] shadow-lg":"text-white/70 hover:bg-white/10"}`,children:e.jsx(se,{})}),e.jsx("button",{onClick:()=>i(!1),className:"text-white/70 hover:text-white p-2",children:e.jsx(M,{})})]})]}),e.jsx("div",{className:"flex gap-2 overflow-x-auto pb-1 custom-scrollbar",children:["Global","Ops","QA","Project","Supply"].map(t=>e.jsx("button",{onClick:()=>re(t),className:`px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase transition-all whitespace-nowrap ${m===t?"bg-white text-[#5d5fef] shadow-md":"bg-white/10 text-white hover:bg-white/20"}`,children:t==="Global"?"ðŸ§  General":t==="Ops"?"ðŸ­ Ops":t==="QA"?"ðŸ›¡ï¸ Calidad":t==="Project"?"ðŸ“… Proyectos":"ðŸ“¦ Compras"},t))})]}),a&&e.jsxs("div",{className:"px-4 py-2 bg-indigo-50 dark:bg-indigo-900/20 border-b border-indigo-100 dark:border-indigo-800/50 flex justify-between items-center animate-fade-in",children:[e.jsxs("div",{className:"flex items-center gap-2 overflow-hidden",children:[e.jsx("span",{className:"text-xl",children:"ðŸ“„"}),e.jsxs("div",{className:"flex flex-col overflow-hidden",children:[e.jsx("span",{className:"text-[9px] font-black text-indigo-400 uppercase tracking-widest",children:"Analizando Documento"}),e.jsx("span",{className:"text-xs font-bold text-indigo-700 dark:text-indigo-300 truncate max-w-[200px]",children:a.name})]})]}),e.jsx("button",{onClick:()=>l(null),className:"text-indigo-400 hover:text-indigo-600 dark:hover:text-indigo-200 p-1",children:e.jsx(M,{})})]}),e.jsxs("div",{className:"flex-grow p-4 overflow-y-auto space-y-4 custom-scrollbar bg-slate-50 dark:bg-[#151520]",children:[p==="text"?e.jsxs(e.Fragment,{children:[K.map(t=>e.jsx("div",{className:`flex ${t.role==="user"?"justify-end":"justify-start"} animate-fade-in`,children:e.jsx("div",{className:`max-w-[90%] p-3.5 rounded-2xl text-sm leading-relaxed shadow-sm ${t.role==="user"?"bg-[#5d5fef] text-white rounded-tr-sm":"bg-white dark:bg-[#252535] text-slate-700 dark:text-slate-200 rounded-tl-sm border border-slate-100 dark:border-white/5"}`,children:e.jsx("div",{className:"prose dark:prose-invert prose-xs",children:e.jsx(ue,{children:t.content})})})},t.id)),J&&e.jsx("div",{className:"flex justify-start",children:e.jsxs("div",{className:"bg-white dark:bg-[#252535] p-4 rounded-3xl rounded-tl-sm border border-slate-100 dark:border-white/5 flex gap-2 items-center",children:[e.jsx("div",{className:"w-2 h-2 bg-[#5d5fef] rounded-full animate-bounce"}),e.jsx("div",{className:"w-2 h-2 bg-[#5d5fef] rounded-full animate-bounce delay-75"}),e.jsx("div",{className:"w-2 h-2 bg-[#5d5fef] rounded-full animate-bounce delay-150"})]})}),_.length>0&&e.jsxs("div",{className:"p-3 bg-indigo-50 dark:bg-indigo-900/10 rounded-xl border border-indigo-100 dark:border-indigo-500/20",children:[e.jsxs("p",{className:"text-[10px] font-bold text-indigo-600 dark:text-indigo-400 uppercase mb-2 flex items-center gap-2",children:[e.jsx(te,{})," Fuentes Verificadas"]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:_.map((t,n)=>e.jsxs("a",{href:t.uri,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-1.5 px-2 py-1 bg-white dark:bg-black/20 rounded-lg text-[10px] font-medium text-slate-600 dark:text-slate-300 hover:text-indigo-500 transition-colors",children:[e.jsx(he,{})," ",t.title.substring(0,20),"..."]},n))})]})]}):e.jsxs("div",{className:"h-full flex flex-col items-center justify-center text-center space-y-8",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:`absolute inset-0 bg-[#5d5fef] rounded-full opacity-20 blur-xl transition-all duration-1000 ${R?"scale-150":"scale-100"}`}),e.jsx("div",{className:`relative w-24 h-24 rounded-full border-4 flex items-center justify-center transition-all duration-300 ${R?"border-[#5d5fef] bg-indigo-50 dark:bg-white/10 scale-110":"border-slate-200 dark:border-white/10 bg-white dark:bg-[#252535]"}`,children:e.jsx("div",{className:`text-3xl ${R?"text-[#5d5fef] animate-pulse":"text-slate-300 dark:text-slate-600"}`,children:e.jsx(se,{})})})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-lg font-bold dark:text-white",children:R?"Escuchando Voz...":"Modo ConversaciÃ³n"}),e.jsx("p",{className:"text-xs text-slate-500 dark:text-slate-400 mt-2 max-w-[200px] mx-auto",children:"Habla naturalmente. El Agente puede escucharte y responder con voz de alta fidelidad."})]}),e.jsx("button",{onClick:T==="connected"?Y:le,className:`px-6 py-3 rounded-full font-bold text-xs shadow-lg transition-transform active:scale-95 ${T==="connected"?"bg-rose-500 text-white":"bg-[#5d5fef] text-white hover:bg-[#4f46e5]"}`,children:T==="connected"?"Desconectar Voz":"Iniciar SesiÃ³n de Voz"})]}),e.jsx("div",{ref:Q})]}),p==="text"&&e.jsxs("div",{className:"p-3 bg-white dark:bg-[#1e1e2d] border-t border-slate-100 dark:border-white/5",children:[w&&e.jsxs("div",{className:"mb-2 flex items-center gap-2 bg-indigo-50 dark:bg-indigo-900/20 px-3 py-1.5 rounded-lg text-xs font-medium text-indigo-700 dark:text-indigo-300",children:[e.jsx(ne,{})," Imagen adjunta",e.jsx("button",{onClick:()=>V(null),className:"ml-auto hover:text-rose-500",children:e.jsx(M,{})})]}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("button",{onClick:()=>q.current?.click(),className:"p-2.5 text-slate-400 hover:text-[#5d5fef] bg-slate-50 dark:bg-white/5 rounded-xl transition-colors",children:e.jsx(ne,{})}),e.jsx("input",{type:"file",ref:q,className:"hidden",accept:"image/*",onChange:ce}),e.jsx("input",{className:"flex-grow bg-slate-50 dark:bg-[#252535] border-transparent focus:border-[#5d5fef] focus:ring-0 rounded-xl px-4 py-2.5 text-sm transition-all dark:text-white placeholder:text-slate-400",placeholder:"Escribe tu consulta...",value:y,onChange:t=>U(t.target.value),onKeyDown:t=>t.key==="Enter"&&X()}),e.jsx("button",{onClick:X,disabled:J||!y&&!w,className:"p-3 bg-[#5d5fef] text-white rounded-xl disabled:opacity-50 hover:bg-[#4f46e5] shadow-lg shadow-indigo-500/20 transition-all active:scale-95",children:e.jsx(be,{})})]})]})]}),e.jsx("button",{onClick:()=>i(),className:`
                    w-14 h-14 rounded-full flex items-center justify-center text-xl shadow-2xl transition-all duration-300 z-50
                    ${r?"bg-slate-800 text-white rotate-90 scale-90":"bg-[#5d5fef] text-white hover:scale-110 hover:shadow-indigo-500/50 animate-bounce-subtle"}
                `,children:r?e.jsx(M,{}):e.jsx(we,{})})]})};export{Ce as default};
