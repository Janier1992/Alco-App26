import{j as e}from"./vendor-ui-Csmkvd-_.js";import{r as d}from"./vendor-react-B11IQRCK.js";import{B as Z}from"./Breadcrumbs-D1gceSdN.js";import{a as V,y as J,z as K,G as ee,R as q,l as se,H as ae,m as te,n as re,e as le}from"./index-K6Oge8P9.js";import{s as b}from"./insforgeClient-BTlHhBMi.js";const me=()=>{const{addNotification:u}=V(),[g,v]=d.useState(!1),[C,E]=d.useState([]),[R,A]=d.useState(!0),[I,F]=d.useState(""),[y,S]=d.useState(null),D={equipoNombre:"",marca:"",cantidad:1,observaciones:""},O={id:"",fecha:new Date().toISOString().split("T")[0],area:"CALIDAD",sede:"",receptorNombre:"",receptorCedula:"",receptorCargo:"",firmaEntrega:"",firmaRecibe:"",items:[D]},[l,n]=d.useState(O),x=d.useRef(null),h=d.useRef(null),[M,w]=d.useState(!1),[B,k]=d.useState(!1),_=async()=>{A(!0);try{const{data:s,error:a}=await b.from("metrology_records").select("*").order("created_at",{ascending:!1});if(a)throw a;const t=(s||[]).map(r=>({id:r.id,fecha:r.date,area:r.area,sede:r.sede||"",receptorNombre:r.receptor_nombre||"",receptorCedula:r.receptor_cedula||"",receptorCargo:r.receptor_cargo||"",firmaEntrega:r.firma_entrega_url||"",firmaRecibe:r.firma_recibe_url||"",items:r.items||[]}));E(t)}catch(s){console.error("Error fetching metrology records:",s),u({type:"error",title:"ERROR DE CARGA",message:"No se pudieron recuperar las actas de metrología."})}finally{A(!1)}};d.useEffect(()=>{_()},[]);const T=async(s,a)=>{if(!s||s.length<100)return"";try{const t=`${a}_${Date.now()}.png`,r=await(await fetch(s)).blob(),{error:o}=await b.storage.from("signatures").upload(t,r,{contentType:"image/png"});if(o)throw o;const c=b.storage.from("signatures").getPublicUrl(t);return c.data?.publicUrl||c}catch(t){return console.error("Error uploading signature:",t),""}},$=()=>{n(s=>({...s,items:[...s.items,D]}))},Y=s=>{l.items.length!==1&&n(a=>({...a,items:a.items.filter((t,r)=>r!==s)}))},f=(s,a,t)=>{const r=[...l.items];r[s]={...r[s],[a]:t},n(o=>({...o,items:r}))},L=(s,a)=>{const t=a.getBoundingClientRect(),r=a.width/t.width,o=a.height/t.height;return{x:(s.clientX-t.left)*r,y:(s.clientY-t.top)*o}},P=(s,a,t)=>{t(!0);const r=a.current?.getContext("2d");if(r&&a.current){const{x:o,y:c}=L(s,a.current);r.beginPath(),r.moveTo(o,c),r.lineWidth=2,r.lineCap="round",r.strokeStyle="#0f172a"}},G=(s,a,t)=>{if(!t)return;const r=a.current?.getContext("2d");if(r&&a.current){const{x:o,y:c}=L(s,a.current);r.lineTo(o,c),r.stroke()}},N=s=>{const a=s.current?.getContext("2d");a&&s.current&&a.clearRect(0,0,s.current.width,s.current.height)},U=()=>{n(O),S(null),v(!1),N(x),N(h)},z=s=>{const{id:a,firmaEntrega:t,firmaRecibe:r,...o}=s;n(o),S(a),v(!0),setTimeout(()=>{const c=(p,Q)=>{if(!p)return;const X=Q.current?.getContext("2d"),j=new Image;j.crossOrigin="anonymous",j.onload=()=>X?.drawImage(j,0,0),j.src=p};t&&c(t,x),r&&c(r,h)},300)},H=async s=>{if(confirm("¿Eliminar esta acta de entrega?"))try{const{error:a}=await b.from("metrology_records").delete().eq("id",s);if(a)throw a;E(t=>t.filter(r=>r.id!==s)),u({type:"error",title:"ACTA ELIMINADA",message:"Registro eliminado de la base de datos."})}catch(a){console.error("Error deleting record:",a),u({type:"error",title:"ERROR",message:"No se pudo eliminar el registro."})}},W=async s=>{s.preventDefault();try{u({type:"info",title:"PROCESANDO...",message:"Guardando registro y firmas..."});const a=x.current?.toDataURL()||"",t=h.current?.toDataURL()||"";let r=l.firmaEntrega||"",o=l.firmaRecibe||"";a.startsWith("data:")&&(r=await T(a,"entregado")),t.startsWith("data:")&&(o=await T(t,"recibido"));const c={date:l.fecha,operator:l.receptorNombre,area:l.area,sede:l.sede,receptor_nombre:l.receptorNombre,receptor_cedula:l.receptorCedula,receptor_cargo:l.receptorCargo,firma_entrega_url:r,firma_recibe_url:o,items:l.items};let p;if(y?p=await b.from("metrology_records").update(c).eq("id",y):p=await b.from("metrology_records").insert([c]),p.error)throw p.error;u({type:"success",title:y?"REGISTRO ACTUALIZADO":"ACTA GENERADA",message:`Asignación a ${l.receptorNombre} guardada correctamente.`}),_(),U()}catch(a){console.error("Error saving metrology record:",a),u({type:"error",title:"ERROR AL GUARDAR",message:a.message})}},m="w-full p-3 bg-slate-50 dark:bg-[#1a1a24] border border-slate-200 dark:border-white/5 rounded-lg text-xs font-bold text-slate-900 dark:text-white focus:ring-2 focus:ring-[#5d5fef] outline-none transition-all uppercase placeholder:text-slate-400",i="text-[9px] font-black text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-1.5 block ml-1";return e.jsxs("div",{className:"space-y-8 animate-fade-in pb-20",children:[e.jsx(Z,{crumbs:[{label:"Metrología",path:"/dashboard"},{label:"Asignación de Activos"}]}),e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center gap-6",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-4xl md:text-5xl font-black text-slate-800 dark:text-white uppercase tracking-tighter leading-none",children:["Acta de ",e.jsx("span",{className:"text-sky-600",children:"Entrega"})]}),e.jsx("p",{className:"text-slate-500 font-bold mt-2 uppercase text-[10px] tracking-widest italic",children:"Gestión de Herramientas y Equipos - Transversal SGC"})]}),e.jsx("button",{onClick:()=>g?U():v(!0),className:`px-8 py-4 rounded-xl text-[10px] font-black uppercase tracking-widest shadow-xl transition-all ${g?"bg-rose-500 text-white shadow-rose-500/20":"bg-sky-600 text-white shadow-sky-500/20 hover:scale-105"}`,children:g?"Cancelar":"Nueva Asignación"})]}),g&&e.jsx("div",{className:"bg-white dark:bg-[#0b0b14] border border-slate-200 dark:border-white/5 p-4 md:p-12 rounded-3xl shadow-2xl animate-fade-in-up",children:e.jsxs("form",{onSubmit:W,className:"space-y-10",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsx("h3",{className:"text-sm font-black text-slate-400 uppercase tracking-[0.3em] border-b dark:border-white/5 pb-2",children:"1. Datos Generales y del Receptor"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:i,children:"Fecha"}),e.jsx("input",{type:"date",value:l.fecha,onChange:s=>n({...l,fecha:s.target.value}),className:m})]}),e.jsxs("div",{children:[e.jsx("label",{className:i,children:"Área"}),e.jsxs("select",{value:l.area,onChange:s=>n({...l,area:s.target.value}),className:m,children:[e.jsx("option",{value:"",children:"SELECCIONE..."}),J.map(s=>e.jsx("option",{children:s},s))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:i,children:"Sede"}),e.jsxs("select",{value:l.sede,onChange:s=>n({...l,sede:s.target.value}),className:m,children:[e.jsx("option",{value:"",children:"SELECCIONE..."}),e.jsx("option",{children:"PLANTA SABANETA"}),e.jsx("option",{children:"PLANTA FUNZA"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:i,children:"Nombre y Apellidos"}),e.jsx("input",{value:l.receptorNombre,onChange:s=>n({...l,receptorNombre:s.target.value}),className:m})]}),e.jsxs("div",{children:[e.jsx("label",{className:i,children:"Cédula"}),e.jsx("input",{value:l.receptorCedula,onChange:s=>n({...l,receptorCedula:s.target.value}),className:m})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:e.jsxs("div",{children:[e.jsx("label",{className:i,children:"Cargo"}),e.jsx("input",{value:l.receptorCargo,onChange:s=>n({...l,receptorCargo:s.target.value}),className:m})]})})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center border-b dark:border-white/5 pb-2",children:[e.jsx("h3",{className:"text-sm font-black text-slate-400 uppercase tracking-[0.3em]",children:"2. Detalle del Equipo / Herramienta"}),e.jsx("button",{type:"button",onClick:$,className:"px-4 py-2 bg-sky-50 text-sky-600 rounded-lg text-[10px] font-black uppercase tracking-widest border border-sky-100 hover:bg-sky-100 transition-colors",children:"+ Agregar Ítem"})]}),e.jsx("div",{className:"space-y-4",children:l.items.map((s,a)=>e.jsxs("div",{className:"bg-slate-50 dark:bg-white/[0.02] p-6 rounded-2xl border border-slate-200 dark:border-white/5 relative group animate-fade-in",children:[a>0&&e.jsx("button",{type:"button",onClick:()=>Y(a),className:"absolute -top-3 -right-3 size-8 bg-rose-500 text-white rounded-full shadow-lg flex items-center justify-center hover:scale-110 transition-transform z-10",title:"Eliminar ítem",children:e.jsx("i",{className:"fas fa-times"})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-12 gap-6",children:[e.jsx("div",{className:"md:col-span-1 flex items-center justify-center",children:e.jsx("span",{className:"size-6 bg-slate-200 dark:bg-slate-700 rounded-full flex items-center justify-center text-[10px] font-black",children:a+1})}),e.jsxs("div",{className:"md:col-span-5",children:[e.jsx("label",{className:i,children:"Nombre Herramienta / Equipo"}),e.jsx("input",{value:s.equipoNombre,onChange:t=>f(a,"equipoNombre",t.target.value),className:m})]}),e.jsxs("div",{className:"md:col-span-4",children:[e.jsx("label",{className:i,children:"Marca"}),e.jsxs("select",{value:s.marca,onChange:t=>f(a,"marca",t.target.value),className:m,children:[e.jsx("option",{value:"",children:"SELECCIONE..."}),K.map(t=>e.jsx("option",{children:t},t))]})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:i,children:"Cant"}),e.jsx("input",{type:"number",min:"1",value:s.cantidad,onChange:t=>f(a,"cantidad",parseInt(t.target.value)),className:m})]}),e.jsxs("div",{className:"md:col-span-12 pl-0 md:pl-[4.5rem]",children:[e.jsx("label",{className:i,children:"Observaciones"}),e.jsx("input",{list:`obs-list-${a}`,value:s.observaciones,onChange:t=>f(a,"observaciones",t.target.value),placeholder:"Estado del equipo...",className:m}),e.jsx("datalist",{id:`obs-list-${a}`,children:ee.map((t,r)=>e.jsx("option",{value:t},r))})]})]})]},a))})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsx("h3",{className:"text-sm font-black text-slate-400 uppercase tracking-[0.3em] border-b dark:border-white/5 pb-2",children:"3. Conformidad y Entrega"}),e.jsx("div",{className:"p-4 bg-amber-50 dark:bg-amber-900/10 border border-amber-100 dark:border-amber-900/30 rounded-xl mb-6",children:e.jsx("p",{className:"text-[10px] font-bold text-amber-700 dark:text-amber-500 uppercase leading-relaxed",children:'"La persona quien recibe las herramientas y/o equipos es responsable del correcto uso y cuidado de las mismas. En cumplimiento al reglamento interno, se compromete a custodiar y almacenar adecuadamente los ítems. En caso de incumplimiento, debe asumir los costos pertinentes."'})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-10",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:i,children:"Firma Quien Entrega (Gestor SGC)"}),e.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-xl border-2 border-dashed border-slate-300 dark:border-slate-600 relative overflow-hidden h-40",children:[e.jsx("canvas",{ref:x,width:400,height:160,className:"w-full h-full cursor-crosshair touch-none",onPointerDown:s=>P(s,x,w),onPointerMove:s=>G(s,x,M),onPointerUp:()=>w(!1),onPointerLeave:()=>w(!1)}),e.jsx("button",{type:"button",onClick:()=>N(x),className:"absolute top-2 right-2 p-2 bg-slate-100 dark:bg-white/10 rounded-lg hover:text-rose-500 text-slate-400",children:e.jsx(q,{className:"scale-75"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:i,children:"Firma Quien Recibe (Colaborador)"}),e.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-xl border-2 border-dashed border-slate-300 dark:border-slate-600 relative overflow-hidden h-40",children:[e.jsx("canvas",{ref:h,width:400,height:160,className:"w-full h-full cursor-crosshair touch-none",onPointerDown:s=>P(s,h,k),onPointerMove:s=>G(s,h,B),onPointerUp:()=>k(!1),onPointerLeave:()=>k(!1)}),e.jsx("button",{type:"button",onClick:()=>N(h),className:"absolute top-2 right-2 p-2 bg-slate-100 dark:bg-white/10 rounded-lg hover:text-rose-500 text-slate-400",children:e.jsx(q,{className:"scale-75"})})]})]})]})]}),e.jsxs("button",{type:"submit",className:"w-full py-5 bg-sky-600 text-white rounded-2xl font-black text-xs uppercase tracking-[0.2em] shadow-xl shadow-sky-600/20 active:scale-95 transition-all hover:scale-[1.01]",children:[e.jsx(se,{})," Registrar Acta de Entrega"]})]})}),e.jsxs("div",{className:"bg-white dark:bg-[#0b0b14] rounded-3xl border border-slate-200 dark:border-white/5 overflow-hidden shadow-xl",children:[e.jsxs("div",{className:"p-8 border-b dark:border-white/5 bg-slate-50 dark:bg-white/[0.02] flex justify-between items-center",children:[e.jsxs("h3",{className:"text-xl font-black uppercase tracking-tighter flex items-center gap-3",children:[e.jsx(ae,{className:"text-sky-600"})," Archivo de Actas"]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{className:"px-10 py-2.5 bg-white dark:bg-[#1a1a24] border dark:border-white/10 rounded-xl text-xs font-bold w-64 outline-none focus:ring-2 focus:ring-sky-500 uppercase",placeholder:"BUSCAR POR RECEPTOR...",value:I,onChange:s=>F(s.target.value)}),e.jsx(te,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"})]})]}),e.jsx("div",{className:"overflow-x-auto custom-scrollbar",children:e.jsxs("table",{className:"w-full text-left min-w-[1000px]",children:[e.jsx("thead",{className:"text-[10px] font-black uppercase text-slate-400 tracking-[0.2em] bg-slate-50/50 dark:bg-slate-800/50 border-b dark:border-white/5",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-8 py-6",children:"Fecha / ID"}),e.jsx("th",{className:"px-6 py-6",children:"Receptor"}),e.jsx("th",{className:"px-6 py-6",children:"Items Asignados"}),e.jsx("th",{className:"px-6 py-6 text-center",children:"Firmas"}),e.jsx("th",{className:"px-8 py-6 text-right",children:"Gestión"})]})}),e.jsxs("tbody",{className:"divide-y dark:divide-white/5",children:[R?e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"px-8 py-12 text-center text-slate-400 text-xs font-bold uppercase animate-pulse",children:"Cargando actas..."})}):C.filter(s=>s.receptorNombre.toLowerCase().includes(I.toLowerCase())).map(s=>e.jsxs("tr",{className:"hover:bg-slate-50 dark:hover:bg-white/5 transition-colors",children:[e.jsxs("td",{className:"px-8 py-6 font-mono text-xs font-bold",children:[e.jsx("p",{className:"text-slate-400 mb-1",children:s.fecha}),e.jsx("span",{className:"text-sky-600 uppercase bg-sky-50 dark:bg-sky-900/30 px-2 py-0.5 rounded",children:s.id})]}),e.jsxs("td",{className:"px-6 py-6",children:[e.jsx("p",{className:"font-black text-xs uppercase text-slate-800 dark:text-white",children:s.receptorNombre}),e.jsx("p",{className:"text-[9px] font-bold text-slate-400 uppercase mt-0.5",children:s.receptorCargo})]}),e.jsx("td",{className:"px-6 py-6",children:s.items.map((a,t)=>e.jsxs("div",{className:"mb-2 last:mb-0",children:[e.jsxs("p",{className:"text-xs font-bold uppercase text-slate-700 dark:text-slate-300",children:["• ",a.cantidad,"x ",a.equipoNombre]}),e.jsxs("p",{className:"text-[9px] uppercase text-slate-500 pl-2",children:[a.marca," - ",a.observaciones.substring(0,25),"..."]})]},t))}),e.jsx("td",{className:"px-6 py-6",children:e.jsx("div",{className:"flex justify-center gap-2",children:s.firmaRecibe?e.jsx("div",{className:"w-8 h-8 rounded-full bg-emerald-50 text-emerald-600 flex items-center justify-center border border-emerald-100",title:"Firmado",children:e.jsx("i",{className:"fas fa-file-signature text-xs"})}):e.jsx("span",{className:"text-slate-300",children:"-"})})}),e.jsxs("td",{className:"px-8 py-6 text-right",children:[e.jsx("button",{onClick:()=>z(s),className:"p-3 bg-sky-50 text-sky-500 rounded-xl hover:bg-sky-500 hover:text-white transition-all shadow-sm mr-2",children:e.jsx(re,{})}),e.jsx("button",{onClick:()=>H(s.id),className:"p-3 bg-rose-50 text-rose-500 rounded-xl hover:bg-rose-500 hover:text-white transition-all shadow-sm",children:e.jsx(le,{})})]})]},s.id)),!R&&C.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"px-8 py-12 text-center text-slate-400 text-xs font-bold uppercase opacity-50",children:"No hay actas registradas"})})]})]})})]})]})};export{me as default};
