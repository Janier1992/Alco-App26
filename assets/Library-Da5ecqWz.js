import{j as e}from"./vendor-ui-Csmkvd-_.js";import{r as i}from"./vendor-react-B11IQRCK.js";import{a as J,p as H,R as A,m as X,V as Y,q as E,f as S,r as K,X as O,s as Q,F as W,l as Z}from"./index-K6Oge8P9.js";import{B as ee}from"./Breadcrumbs-D1gceSdN.js";import{s as h}from"./insforgeClient-BTlHhBMi.js";const oe=()=>{const{addNotification:l}=J(),{setActiveDocument:T,toggleAgent:U}=H(),[x,L]=i.useState([]),[F,N]=i.useState(!0),[f,M]=i.useState(""),[d,P]=i.useState("Todos"),[V,b]=i.useState(!1),[n,y]=i.useState(null),[r,c]=i.useState({name:"",code:"",category:"Manuales",status:"Aprobado",version:"V1.0",author:"",validUntil:""}),[u,j]=i.useState(null),w=i.useRef(null),g=async()=>{N(!0);try{const{data:t,error:s}=await h.from("sgc_documents").select("*").order("date",{ascending:!1});if(s)throw s;const o=(t||[]).map(a=>({id:a.id,name:a.name,code:a.code,category:a.category,date:a.date,validUntil:a.valid_until,size:a.size,version:a.version,status:a.status,author:a.author,url:a.file_url,mime:a.mime_type}));L(o)}catch(t){console.error("Error fetching documents:",t),l({type:"error",title:"ERROR DE CARGA",message:"No se pudo recuperar la biblioteca de documentos."})}finally{N(!1)}};i.useEffect(()=>{g()},[]);const z=i.useMemo(()=>{const t=x.reduce((s,o)=>(s[o.category]=(s[o.category]||0)+1,s),{});return[{id:"Todos",label:"Raíz / Todo",count:x.length,icon:"fas fa-layer-group"},{id:"Manuales",label:"Manuales",count:t.Manuales||0,icon:"fas fa-book"},{id:"Instructivos",label:"Instructivos",count:t.Instructivos||0,icon:"fas fa-chalkboard-teacher"},{id:"Planos",label:"Planos",count:t.Planos||0,icon:"fas fa-drafting-compass"},{id:"Fichas Técnicas",label:"Fichas Técnicas",count:t["Fichas Técnicas"]||0,icon:"fas fa-microchip"},{id:"Registros",label:"Registros",count:t.Registros||0,icon:"fas fa-file-signature"}]},[x]),k=t=>{if(!t.validUntil)return t.status;const s=new Date;return new Date(t.validUntil)<s?"CADUCADO":t.status},C=i.useMemo(()=>x.filter(t=>{const s=t.name.toLowerCase().includes(f.toLowerCase())||t.code.toLowerCase().includes(f.toLowerCase()),o=d==="Todos"||t.category===d;return s&&o}),[x,f,d]),G=()=>{b(!0),c({name:"",code:"",category:"Manuales",status:"Aprobado",version:"V1.0",author:"",validUntil:""}),j(null)},_=t=>{const s=t.target.files?.[0];if(s){if(s.type!=="application/pdf"){l({type:"error",title:"FORMATO INVÁLIDO",message:"Por favor sube solo archivos PDF."});return}const o=URL.createObjectURL(s);j({file:s,url:o}),c(a=>({...a,name:a.name||s.name.split(".")[0],size:(s.size/(1024*1024)).toFixed(1)+" MB"}))}},$=async t=>{if(t.preventDefault(),!u||!r.name||!r.code){l({type:"error",title:"FALTA INFORMACIÓN",message:"Debes completar los campos y adjuntar un PDF."});return}try{l({type:"info",title:"PROCESANDO",message:"Subiendo archivo al servidor seguro..."});const s=`${r.code}_${Date.now()}.pdf`,{error:o}=await h.storage.from("quality-documents").upload(s,u.file);if(o)throw o;const a=h.storage.from("quality-documents").getPublicUrl(s),v=typeof a=="string"?a:a.data?.publicUrl||a.publicUrl,B={name:r.name,code:r.code,category:r.category,date:new Date().toISOString().split("T")[0],valid_until:r.validUntil||null,size:r.size,version:r.version,status:"Aprobado",author:r.author||"Usuario Sistema",file_url:v,mime_type:"application/pdf"},{error:R}=await h.from("sgc_documents").insert([B]);if(R)throw R;l({type:"success",title:"DOCUMENTO CARGADO",message:`El archivo ${r.code} ha sido incorporado al SGC.`}),g(),b(!1),j(null)}catch(s){console.error("Error saving document:",s),l({type:"error",title:"ERROR",message:s.message})}},q=async t=>{if(confirm("¿Desea eliminar permanentemente este documento del repositorio oficial?"))try{const{error:s}=await h.from("sgc_documents").delete().eq("id",t);if(s)throw s;l({type:"error",title:"DOC ELIMINADO",message:"La información ha sido purgada de la base de datos."}),g()}catch{l({type:"error",title:"ERROR",message:"No se pudo eliminar el documento."})}},D=t=>{if(!t.url){l({type:"error",title:"ERROR DESCARGA",message:"Archivo no disponible."});return}window.open(t.url,"_blank"),l({type:"success",title:"DESCARGA INICIADA",message:"El documento se está abriendo en una nueva pestaña."})},I=async t=>{if(!t.url){l({type:"error",title:"IA NO DISPONIBLE",message:"Este documento no tiene contenido legible por la IA."});return}try{l({type:"info",title:"PROCESANDO IA",message:"Recuperando contenido para análisis..."});const o=await(await fetch(t.url)).blob(),a=new FileReader;a.onloadend=()=>{const v=a.result.split(",")[1];T({name:t.name,content:v,mime:t.mime||"application/pdf"}),U(!0)},a.readAsDataURL(o),l({type:"info",title:"COPILOT ACTIVADO",message:`Analizando ${t.code} con IA...`})}catch{l({type:"error",title:"ERROR IA",message:"No se pudo procesar el documento para la IA."})}},p="w-full p-4 bg-slate-50 dark:bg-[#1a1a24] border border-slate-200 dark:border-white/5 rounded-2xl text-xs font-bold text-slate-900 dark:text-white focus:ring-2 focus:ring-[#5d5fef] outline-none uppercase transition-all placeholder:text-slate-400",m="text-[10px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-2 block ml-1";return e.jsxs("div",{className:"space-y-8 animate-fade-in pb-20",children:[e.jsx(ee,{crumbs:[{label:"INGENIERÍA Y SGC",path:"/dashboard"},{label:"GESTIÓN DOCUMENTAL"}]}),e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center gap-6",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-4xl md:text-5xl font-black text-slate-800 dark:text-white uppercase tracking-tighter leading-none",children:["Explorador de ",e.jsx("span",{className:"text-sky-600",children:"Documentos"})]}),e.jsx("p",{className:"text-slate-500 font-bold mt-2 uppercase text-xs tracking-widest",children:"Control de información documentada ISO 9001:2015"})]}),e.jsxs("div",{className:"flex gap-3 w-full md:w-auto",children:[e.jsx("button",{onClick:()=>g(),className:"p-4 bg-white dark:bg-alco-surface border border-slate-200 dark:border-white/5 rounded-2xl text-slate-400 hover:text-[#5d5fef] transition-all shadow-sm",children:e.jsx(A,{})}),e.jsxs("button",{onClick:G,className:"flex-grow md:flex-none px-8 py-4 bg-[#5d5fef] text-white rounded-[2rem] text-[10px] font-black uppercase tracking-widest transition-all shadow-xl shadow-[#5d5fef]/20 hover:scale-105 active:scale-95 flex items-center justify-center gap-2",children:[e.jsx("i",{className:"fas fa-upload"})," Nueva Versión"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-12 gap-8",children:[e.jsx("div",{className:"lg:col-span-3 space-y-6",children:e.jsxs("div",{className:"premium-card p-6 shadow-sm",children:[e.jsx("h3",{className:"text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-6 px-2",children:"Categorías SGC"}),e.jsx("div",{className:"grid grid-cols-2 lg:grid-cols-1 gap-2",children:z.map(t=>e.jsxs("button",{onClick:()=>P(t.id),className:`flex items-center justify-between p-3.5 rounded-2xl transition-all group ${d===t.id?"bg-[#5d5fef]/10 text-[#5d5fef]":"text-slate-500 hover:bg-slate-50 dark:hover:bg-white/5"}`,children:[e.jsxs("div",{className:"flex items-center gap-3 truncate",children:[e.jsx("i",{className:`${t.icon} text-sm ${d===t.id?"text-[#5d5fef]":"text-slate-400"}`}),e.jsx("span",{className:"text-[10px] font-black uppercase tracking-tight truncate",children:t.label})]}),e.jsx("span",{className:`hidden sm:inline text-[9px] font-bold px-2 py-0.5 rounded-full ${d===t.id?"bg-[#5d5fef]/20 text-[#5d5fef]":"bg-slate-100 dark:bg-white/5 text-slate-400"}`,children:t.count})]},t.id))})]})}),e.jsxs("div",{className:"lg:col-span-9 space-y-6",children:[e.jsxs("div",{className:"relative group",children:[e.jsx("input",{className:"w-full pl-14 pr-6 py-5 bg-white dark:bg-alco-surface border border-slate-200 dark:border-white/5 rounded-[2.5rem] shadow-sm text-sm font-bold text-slate-800 dark:text-white focus:ring-2 focus:ring-[#5d5fef] transition-all outline-none",placeholder:"Buscar por código (ej: PL-TH) o nombre de documento...",value:f,onChange:t=>M(t.target.value)}),e.jsx("div",{className:"absolute left-6 top-1/2 -translate-y-1/2 text-slate-400 group-hover:text-[#5d5fef] transition-colors text-xl",children:e.jsx(X,{})})]}),e.jsx("div",{className:"premium-card overflow-hidden animate-fade-in shadow-xl",children:F?e.jsxs("div",{className:"p-20 text-center space-y-4",children:[e.jsx("div",{className:"animate-spin text-4xl text-[#5d5fef] flex justify-center",children:e.jsx(A,{})}),e.jsx("p",{className:"text-[10px] font-black uppercase tracking-widest text-slate-400",children:"Consultando Repositorio Insforge..."})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-left",children:[e.jsx("thead",{className:"bg-slate-50 dark:bg-white/5",children:e.jsxs("tr",{className:"text-[9px] font-black text-slate-400 uppercase tracking-[0.2em]",children:[e.jsx("th",{className:"px-6 py-4",children:"Documento"}),e.jsx("th",{className:"px-6 py-4",children:"Versión"}),e.jsx("th",{className:"px-6 py-4",children:"Fecha"}),e.jsx("th",{className:"px-6 py-4",children:"Estatus"}),e.jsx("th",{className:"px-6 py-4 text-right",children:"Gestión"})]})}),e.jsx("tbody",{className:"divide-y divide-slate-100 dark:divide-white/5",children:C.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"px-6 py-12 text-center text-xs font-bold text-slate-300 uppercase italic",children:"No se encontraron documentos"})}):C.map(t=>e.jsxs("tr",{className:"hover:bg-slate-50 dark:hover:bg-white/5 transition-all group",children:[e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-xl bg-rose-50 dark:bg-rose-500/10 flex items-center justify-center text-rose-500 font-bold text-xs shadow-sm",children:"PDF"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-[11px] font-black text-slate-800 dark:text-slate-100 uppercase leading-none",children:t.name}),e.jsx("p",{className:"text-[9px] font-bold text-sky-600 mt-1",children:t.code})]})]})}),e.jsx("td",{className:"px-6 py-4 text-[10px] font-bold text-slate-500",children:t.version}),e.jsx("td",{className:"px-6 py-4 text-[10px] font-bold text-slate-500",children:t.date}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("span",{className:`px-2 py-0.5 rounded-full text-[9px] font-black uppercase tracking-tighter ${k(t)==="Aprobado"?"bg-emerald-100 text-emerald-600":"bg-rose-100 text-rose-600"}`,children:k(t)})}),e.jsx("td",{className:"px-6 py-4 text-right",children:e.jsxs("div",{className:"flex justify-end gap-1 opacity-60 group-hover:opacity-100 transition-opacity",children:[e.jsx("button",{onClick:()=>y(t),className:"p-2 hover:bg-sky-100 dark:hover:bg-sky-500/20 text-sky-600 rounded-lg transition-all",title:"Vista Previa",children:e.jsx(Y,{})}),e.jsx("button",{onClick:()=>D(t),className:"p-2 hover:bg-emerald-100 dark:hover:bg-emerald-500/20 text-emerald-600 rounded-lg transition-all",title:"Descargar",children:e.jsx(E,{})}),e.jsx("button",{onClick:()=>I(t),className:"p-2 hover:bg-violet-100 dark:hover:bg-violet-500/20 text-violet-600 rounded-lg transition-all",title:"Consultar con Copilot",children:e.jsx(S,{})}),e.jsx("button",{onClick:()=>q(t.id),className:"p-2 hover:bg-rose-100 dark:hover:bg-rose-500/20 text-rose-600 rounded-lg transition-all",title:"Eliminar",children:e.jsx(K,{})})]})})]},t.id))})]})})})]})]}),V&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-md animate-fade-in",children:e.jsxs("div",{className:"bg-white dark:bg-alco-dark w-full max-w-2xl rounded-[2.5rem] shadow-2xl overflow-hidden border border-slate-200 dark:border-white/10 animate-scale-in",children:[e.jsxs("div",{className:"p-8 border-b border-slate-100 dark:border-white/5 flex justify-between items-center bg-slate-50 dark:bg-alco-surface/50",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"text-xl font-black text-slate-800 dark:text-white uppercase tracking-tighter",children:["Cargar Nuevo ",e.jsx("span",{className:"text-[#5d5fef]",children:"Documento"})]}),e.jsx("p",{className:"text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1",children:"Biblioteca SGC - Control ISO 9001"})]}),e.jsx("button",{onClick:()=>b(!1),className:"p-3 bg-white dark:bg-alco-surface rounded-2xl text-slate-400 hover:text-rose-500 transition-all border border-slate-200 dark:border-white/5 shadow-sm",children:e.jsx(O,{})})]}),e.jsxs("form",{onSubmit:$,className:"p-8 space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:m,children:"Nombre del Documento *"}),e.jsx("input",{required:!0,value:r.name,onChange:t=>c({...r,name:t.target.value}),className:p,placeholder:"EJ: MANUAL DE PROCEDIMIENTOS DE CALIDAD"})]}),e.jsxs("div",{children:[e.jsx("label",{className:m,children:"Código / Referencia *"}),e.jsx("input",{required:!0,value:r.code,onChange:t=>c({...r,code:t.target.value}),className:p,placeholder:"EJ: MC-ALCO-01"})]}),e.jsxs("div",{children:[e.jsx("label",{className:m,children:"Categoría *"}),e.jsxs("select",{value:r.category,onChange:t=>c({...r,category:t.target.value}),className:p,children:[e.jsx("option",{value:"Manuales",children:"Manuales"}),e.jsx("option",{value:"Instructivos",children:"Instructivos"}),e.jsx("option",{value:"Planos",children:"Planos"}),e.jsx("option",{value:"Fichas Técnicas",children:"Fichas Técnicas"}),e.jsx("option",{value:"Registros",children:"Registros"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:m,children:"Vencimiento (Opcional)"}),e.jsx("input",{type:"date",value:r.validUntil,onChange:t=>c({...r,validUntil:t.target.value}),className:p})]}),e.jsxs("div",{children:[e.jsx("label",{className:m,children:"Versión"}),e.jsx("input",{required:!0,value:r.version,onChange:t=>c({...r,version:t.target.value}),className:p,placeholder:"EJ: V1.0"})]})]}),e.jsxs("div",{className:"pt-4",children:[e.jsx("input",{type:"file",ref:w,onChange:_,className:"hidden",accept:".pdf"}),e.jsx("div",{onClick:()=>w.current?.click(),className:`border-2 border-dashed rounded-3xl p-10 text-center cursor-pointer transition-all ${u?"border-emerald-500 bg-emerald-50 dark:bg-emerald-500/5":"border-slate-200 dark:border-white/10 hover:border-[#5d5fef] hover:bg-slate-50 dark:hover:bg-white/5"}`,children:u?e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-3xl text-emerald-500 mb-2 flex justify-center",children:e.jsx(Q,{})}),e.jsx("p",{className:"text-xs font-black text-slate-800 dark:text-white uppercase",children:u.file.name}),e.jsx("p",{className:"text-[10px] font-bold text-emerald-600",children:r.size})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-3xl text-slate-300 flex justify-center",children:e.jsx(W,{})}),e.jsxs("p",{className:"text-xs font-black text-slate-400 uppercase tracking-widest leading-tight",children:["Haz clic para seleccionar",e.jsx("br",{}),"un archivo PDF"]})]})})]}),e.jsxs("button",{type:"submit",className:"w-full py-5 bg-[#5d5fef] text-white rounded-3xl font-black text-xs uppercase tracking-[0.2em] shadow-xl shadow-[#5d5fef]/20 hover:scale-[1.02] active:scale-95 transition-all flex items-center justify-center gap-3",children:[e.jsx(Z,{})," Incorporar al Repositorio Oficial"]})]})]})}),n&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-md animate-fade-in",children:e.jsxs("div",{className:"bg-white dark:bg-alco-dark w-full h-full max-w-6xl rounded-[2.5rem] shadow-2xl overflow-hidden border border-slate-200 dark:border-white/10 flex flex-col",children:[e.jsxs("div",{className:"p-6 border-b border-slate-100 dark:border-white/5 flex justify-between items-center bg-slate-50 dark:bg-alco-surface/50",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-black text-slate-800 dark:text-white uppercase tracking-tighter",children:n.name}),e.jsxs("p",{className:"text-[10px] font-bold text-sky-600 uppercase tracking-widest",children:[n.code," - VERSIÓN ",n.version]})]}),e.jsx("button",{onClick:()=>y(null),className:"p-3 bg-white dark:bg-alco-surface rounded-2xl text-slate-400 hover:text-rose-500 transition-all border border-slate-200 dark:border-white/5 shadow-sm",children:e.jsx(O,{})})]}),e.jsx("div",{className:"flex-1 bg-slate-200 dark:bg-[#1a1a24]",children:e.jsx("iframe",{src:n.url,className:"w-full h-full border-none",title:"Vista Previa Documento"})}),e.jsxs("div",{className:"p-6 bg-slate-50 dark:bg-alco-surface/50 border-t border-slate-100 dark:border-white/5 flex justify-end gap-3",children:[e.jsxs("button",{onClick:()=>D(n),className:"px-6 py-3 bg-emerald-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest flex items-center gap-2",children:[e.jsx(E,{})," Descargar Copia"]}),e.jsxs("button",{onClick:()=>I(n),className:"px-6 py-3 bg-violet-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest flex items-center gap-2",children:[e.jsx(S,{})," Consultar Copilot"]})]})]})})]})};export{oe as default};
