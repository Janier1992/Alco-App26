import{j as e}from"./vendor-ui-Csmkvd-_.js";import{r as m}from"./vendor-react-B11IQRCK.js";import{B as Y}from"./Breadcrumbs-D1gceSdN.js";import{a as Q,f as G,P as V,W as z,Q as q,K as $,g as W,q as K,S as H,Y as J,Z}from"./index-CRB8BTUJ.js";import{s as I}from"./insforgeClient-BTlHhBMi.js";import{B as X}from"./BulkUploadButton-COujV333.js";import"./vendor-core-L0lX3Z62.js";const ee=({isOpen:r,onClose:l,onCapture:d})=>{const u=m.useRef(null),b=m.useRef(null);m.useEffect(()=>(r&&(async()=>{try{const c=await navigator.mediaDevices.getUserMedia({video:!0});b.current=c,u.current&&(u.current.srcObject=c)}catch(c){console.error("Error accessing camera:",c),alert("No se pudo acceder a la cámara. Asegúrese de haber otorgado los permisos necesarios."),l()}})(),()=>{b.current&&(b.current.getTracks().forEach(c=>c.stop()),b.current=null)}),[r,l]);const a=()=>{const s=u.current;if(s){const c=document.createElement("canvas");c.width=s.videoWidth,c.height=s.videoHeight;const g=c.getContext("2d");if(g){g.drawImage(s,0,0,c.width,c.height);const y=c.toDataURL("image/jpeg");d(y)}l()}};return r?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-75 z-[1002] flex justify-center items-center p-4",children:e.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-lg",children:[e.jsx("div",{className:"p-4 border-b dark:border-slate-700",children:e.jsx("h2",{className:"text-xl font-bold text-sky-900 dark:text-sky-300",children:"Capturar Evidencia"})}),e.jsx("div",{className:"p-4",children:e.jsx("video",{ref:u,autoPlay:!0,playsInline:!0,className:"w-full rounded-md"})}),e.jsxs("div",{className:"flex justify-end gap-3 p-4 border-t dark:border-slate-700",children:[e.jsx("button",{onClick:l,type:"button",className:"px-4 py-2 bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 rounded-md hover:bg-slate-300 dark:hover:bg-slate-500 transition-colors",children:"Cancelar"}),e.jsxs("button",{onClick:a,type:"button",className:"px-4 py-2 bg-sky-700 text-white rounded-md hover:bg-sky-800 transition-colors flex items-center gap-2",children:[e.jsx(W,{})," Capturar"]})]})]})}):null},te=({isOpen:r,onClose:l,attachment:d})=>{if(!r||!d)return null;const u=()=>{const a=document.createElement("a");a.href=d.url,a.setAttribute("download",d.name),document.body.appendChild(a),a.click(),document.body.removeChild(a)},b=()=>d.type?.startsWith("image/")?e.jsx("img",{src:d.url,alt:d.name,className:"max-w-full max-h-[60vh] mx-auto rounded-md"}):d.type==="application/pdf"?e.jsx("iframe",{src:d.url,className:"w-full h-[70vh] border-0 rounded-md",title:d.name}):e.jsxs("div",{className:"p-4 h-48 flex flex-col items-center justify-center bg-slate-100 dark:bg-slate-900/50 rounded-lg border-2 border-dashed dark:border-slate-700 text-center",children:[e.jsx("i",{className:"fas fa-file-alt text-4xl text-slate-400 dark:text-slate-500 mb-3"}),e.jsx("p",{className:"text-slate-600 dark:text-slate-400 font-semibold",children:"Vista Previa no Disponible"})]});return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-60 z-[1002] flex justify-center items-center p-4",onClick:l,children:e.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col",onClick:a=>a.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center p-4 border-b dark:border-slate-700 flex-shrink-0",children:[e.jsx("h2",{className:"text-xl font-bold text-sky-900 dark:text-sky-300 truncate pr-4",children:d.name}),e.jsx("button",{onClick:l,className:"text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-slate-200 text-2xl flex-shrink-0",children:"×"})]}),e.jsx("div",{className:"p-6 overflow-y-auto",children:b()}),e.jsxs("div",{className:"flex justify-end gap-3 p-4 border-t dark:border-slate-700 flex-shrink-0",children:[e.jsx("button",{onClick:l,className:"px-4 py-2 bg-slate-200 dark:bg-slate-600 rounded-md",children:"Cerrar"}),e.jsxs("button",{onClick:u,className:"px-4 py-2 bg-sky-700 text-white rounded-md flex items-center gap-2",children:[e.jsx(K,{})," Descargar"]})]})]})})},F=({label:r,items:l,selectedItems:d,availableItems:u,onAdd:b,onRemove:a})=>{const[s,c]=m.useState(!1),g=x=>"color"in x,y={blue:"bg-blue-100 text-blue-800",purple:"bg-purple-100 text-purple-800",green:"bg-green-100 text-green-800",yellow:"bg-yellow-100 text-yellow-800",red:"bg-red-100 text-red-800",gray:"bg-gray-100 text-gray-800"};return e.jsxs("div",{children:[e.jsx("label",{className:"font-medium text-slate-600 dark:text-slate-400 block mb-1 text-sm",children:r}),e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"flex flex-wrap gap-1 p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md min-h-[42px]",children:[d.map(x=>e.jsxs("span",{className:`flex items-center gap-2 text-xs font-medium px-2 py-1 rounded ${g(x)?y[x.color]:"bg-sky-100 text-sky-800 dark:bg-sky-900/50 dark:text-sky-300"}`,children:[g(x)?x.name:x.initials,e.jsx("button",{onClick:()=>a(x.id),className:"font-bold",children:"×"})]},x.id)),e.jsx("button",{onClick:()=>c(!s),className:"p-1 rounded-full bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600",children:e.jsx(V,{})})]}),s&&e.jsx("div",{className:"absolute z-10 w-full mt-1 bg-white dark:bg-slate-700 rounded-md shadow-lg max-h-40 overflow-y-auto",children:u.map(x=>e.jsx("div",{onClick:()=>{b(x),c(!1)},className:"px-3 py-2 hover:bg-slate-100 dark:hover:bg-slate-600 cursor-pointer",children:g(x)?x.name:x.initials},x.id))})]})]})},se=({attachments:r,onFilesAdd:l,onRemove:d,onTakePhotoClick:u,onView:b})=>{const a=m.useRef(null);return e.jsxs("div",{children:[e.jsx("label",{className:"font-medium text-slate-600 dark:text-slate-400 block mb-2 text-sm",children:"Evidencia y Archivos"}),e.jsx("div",{className:"space-y-2 mb-2",children:r.map(s=>e.jsxs("button",{type:"button",onClick:()=>b(s),className:"w-full flex items-center justify-between p-2 bg-slate-100 dark:bg-slate-700/50 rounded-md text-left hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2 overflow-hidden",children:[s.type?.startsWith("image/")?e.jsx("img",{src:s.url,alt:s.name,className:"w-8 h-8 rounded object-cover flex-shrink-0"}):e.jsx("div",{className:"w-8 h-8 bg-slate-300 dark:bg-slate-600 rounded flex items-center justify-center flex-shrink-0",children:e.jsx("i",{className:"fas fa-file-alt"})}),e.jsxs("div",{className:"truncate",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:s.name}),e.jsxs("p",{className:"text-xs text-slate-500 dark:text-slate-400",children:[(s.size/1024/1024).toFixed(2)," MB"]})]})]}),e.jsx("button",{onClick:c=>{c.stopPropagation(),d(s.id)},className:"p-1 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50 text-red-500 flex-shrink-0 z-10",children:"×"})]},s.id))}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2",children:[e.jsxs("button",{type:"button",onClick:()=>a.current?.click(),className:"w-full p-2 text-sm border-2 border-dashed border-slate-300 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-md transition-colors flex items-center justify-center gap-2",children:[e.jsx($,{})," Adjuntar Archivo"]}),e.jsxs("button",{type:"button",onClick:u,className:"w-full p-2 text-sm border-2 border-dashed border-slate-300 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-md transition-colors flex items-center justify-center gap-2",children:[e.jsx(W,{})," Tomar Foto"]})]}),e.jsx("input",{type:"file",multiple:!0,ref:a,className:"hidden",onChange:s=>s.target.files&&l(s.target.files)})]})},ae=({isOpen:r,onClose:l,task:d,onSave:u,onDelete:b})=>{const[a,s]=m.useState(d),[c,g]=m.useState(!1),[y,x]=m.useState(!1),[S,w]=m.useState(null);if(m.useEffect(()=>{s(d)},[d]),!r||!a)return null;const k=()=>{u(a),l()},E=n=>{Array.from(n).forEach(o=>{const v=new FileReader;v.onload=R=>{const t={id:`${Date.now()}`,name:o.name,size:o.size,type:o.type,url:R.target?.result};s(i=>i?{...i,attachments:[...i.attachments,t]}:null)},v.readAsDataURL(o)})},O=n=>{const o={id:`capture-${Date.now()}`,name:`Evidencia-${Date.now()}.jpg`,type:"image/jpeg",url:n,size:5e4};s(v=>v?{...v,attachments:[...v.attachments,o]}:null),g(!1)},C="w-full p-2 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-50 rounded-md focus:ring-2 focus:ring-sky-500 outline-none transition-colors",D="font-medium text-slate-600 dark:text-slate-400 block mb-1 text-sm",P=z.filter(n=>!a.assignedUsers.some(o=>o.id===n.id)),M=q.filter(n=>!a.labels.some(o=>o.id===n.id));return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-[1001] flex justify-center items-center p-4",onClick:l,children:e.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col",onClick:n=>n.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-start p-4 border-b dark:border-slate-700",children:[e.jsxs("div",{className:"w-full mr-4",children:[e.jsx("label",{className:"text-xs uppercase text-slate-400 font-bold mb-1 block",children:"Título de la Orden"}),e.jsx("input",{type:"text",value:a.title,onChange:n=>s({...a,title:n.target.value}),className:"text-xl font-bold text-slate-800 dark:text-slate-100 bg-transparent border-b border-transparent hover:border-slate-300 focus:border-sky-500 focus:ring-0 w-full p-1"})]}),e.jsx("button",{onClick:l,className:"text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-slate-200 text-2xl",children:"×"})]}),e.jsxs("div",{className:"p-4 md:p-6 overflow-y-auto grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 bg-slate-50 dark:bg-slate-900/50 p-4 rounded-lg border border-slate-200 dark:border-slate-700",children:[e.jsxs("div",{children:[e.jsx("label",{className:D,children:"Activo / Equipo"}),e.jsx("input",{type:"text",value:a.assetId||"",onChange:n=>s({...a,assetId:n.target.value}),className:C,placeholder:"Ej: TRQ-01"})]}),e.jsxs("div",{children:[e.jsx("label",{className:D,children:"Tipo de Mantenimiento"}),e.jsxs("select",{value:a.type||"Correctivo",onChange:n=>s({...a,type:n.target.value}),className:C,children:[e.jsx("option",{value:"Correctivo",children:"Correctivo"}),e.jsx("option",{value:"Preventivo",children:"Preventivo"}),e.jsx("option",{value:"Predictivo",children:"Predictivo"}),e.jsx("option",{value:"Locativo",children:"Locativo"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:D,children:"Descripción Detallada"}),e.jsx("textarea",{value:a.description,onChange:n=>s({...a,description:n.target.value}),className:`${C} min-h-[120px]`,placeholder:"Describa el problema, repuestos necesarios, etc."})]}),e.jsx(se,{attachments:a.attachments,onFilesAdd:E,onRemove:n=>s(o=>o?{...o,attachments:o.attachments.filter(v=>v.id!==n)}:null),onTakePhotoClick:()=>g(!0),onView:n=>{w(n),x(!0)}})]}),e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{children:[e.jsx("label",{className:D,children:"Estado / Columna"}),e.jsx("div",{className:"px-3 py-2 bg-slate-100 dark:bg-slate-700 rounded-md text-sm font-semibold text-slate-600 dark:text-slate-300",children:a.id?"Actualizar estado arrastrando la tarjeta":"Nueva"})]}),e.jsxs("div",{children:[e.jsx("label",{className:D,children:"Prioridad"}),e.jsxs("select",{value:a.priority,onChange:n=>s({...a,priority:n.target.value}),className:C,children:[e.jsx("option",{children:"Baja"}),e.jsx("option",{children:"Media"}),e.jsx("option",{children:"Alta"}),e.jsx("option",{children:"Crítica"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:D,children:"Fecha Vencimiento"}),e.jsx("input",{type:"date",value:a.dueDate,onChange:n=>s({...a,dueDate:n.target.value}),className:`${C} dark:[color-scheme:dark]`})]}),e.jsx(F,{label:"Técnicos Asignados",items:z,selectedItems:a.assignedUsers,availableItems:P,onAdd:n=>s(o=>o?{...o,assignedUsers:[...o.assignedUsers,n]}:null),onRemove:n=>s(o=>o?{...o,assignedUsers:o.assignedUsers.filter(v=>v.id!==n)}:null)}),e.jsx(F,{label:"Etiquetas",items:q,selectedItems:a.labels,availableItems:M,onAdd:n=>s(o=>o?{...o,labels:[...o.labels,n]}:null),onRemove:n=>s(o=>o?{...o,labels:o.labels.filter(v=>v.id!==n)}:null)}),e.jsx("button",{onClick:()=>{b(a.id),l()},className:"w-full px-4 py-2 mt-8 border border-red-500 text-red-500 rounded-md hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors text-sm",children:"Eliminar Orden"})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 p-4 border-t dark:border-slate-700 bg-slate-50 dark:bg-slate-900/30 rounded-b-lg",children:[e.jsx("button",{onClick:l,className:"px-4 py-2 bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 rounded-md hover:bg-slate-300 dark:hover:bg-slate-500 transition-colors",children:"Cancelar"}),e.jsx("button",{onClick:k,className:"px-6 py-2 bg-sky-700 text-white rounded-md hover:bg-sky-800 transition-colors font-semibold shadow-sm",children:"Guardar Cambios"})]})]})}),e.jsx(ee,{isOpen:c,onClose:()=>g(!1),onCapture:O}),e.jsx(te,{isOpen:y,onClose:()=>x(!1),attachment:S})]})},re=({isOpen:r,onClose:l,onSave:d})=>{const[u,b]=m.useState(""),[a,s]=m.useState("Media"),[c,g]=m.useState("Correctivo"),[y,x]=m.useState("");if(!r)return null;const S=()=>{u.trim()?(d(u,a,c,y),b(""),s("Media"),g("Correctivo"),x(""),l()):alert("El título es obligatorio.")},w="w-full p-2 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-50 rounded-md focus:ring-2 focus:ring-sky-500 outline-none";return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-[1001] flex justify-center items-center p-4",onClick:l,children:e.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto",onClick:k=>k.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center p-4 border-b dark:border-slate-700",children:[e.jsx("h2",{className:"text-xl font-bold text-sky-900 dark:text-sky-300",children:"Nueva Orden de Trabajo"}),e.jsx("button",{onClick:l,className:"text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-slate-200 text-2xl",children:"×"})]}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"font-medium text-slate-600 dark:text-slate-400 block mb-1 text-sm",children:"Título de la OT"}),e.jsx("input",{type:"text",value:u,onChange:k=>b(k.target.value),className:w,placeholder:"Ej: Fuga en Troqueladora"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"font-medium text-slate-600 dark:text-slate-400 block mb-1 text-sm",children:"Activo / Equipo"}),e.jsx("input",{type:"text",value:y,onChange:k=>x(k.target.value),className:w,placeholder:"Ej: TRQ-01"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"font-medium text-slate-600 dark:text-slate-400 block mb-1 text-sm",children:"Tipo"}),e.jsxs("select",{value:c,onChange:k=>g(k.target.value),className:w,children:[e.jsx("option",{children:"Correctivo"}),e.jsx("option",{children:"Preventivo"}),e.jsx("option",{children:"Predictivo"}),e.jsx("option",{children:"Locativo"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"font-medium text-slate-600 dark:text-slate-400 block mb-1 text-sm",children:"Prioridad"}),e.jsxs("select",{value:a,onChange:k=>s(k.target.value),className:w,children:[e.jsx("option",{children:"Baja"}),e.jsx("option",{children:"Media"}),e.jsx("option",{children:"Alta"}),e.jsx("option",{children:"Crítica"})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 p-4 border-t dark:border-slate-700",children:[e.jsx("button",{onClick:l,className:"px-4 py-2 bg-slate-200 dark:bg-slate-600 rounded-md",children:"Cancelar"}),e.jsx("button",{onClick:S,className:"px-4 py-2 bg-sky-700 text-white rounded-md font-semibold shadow-sm",children:"Crear Orden"})]})]})})},le=({task:r,onDragStart:l,columnId:d,onClick:u})=>{const b={Baja:"bg-green-100 text-green-800",Media:"bg-yellow-100 text-yellow-800",Alta:"bg-orange-100 text-orange-800",Crítica:"bg-red-100 text-red-800"},a=s=>s==="Preventivo"?e.jsx(H,{}):s==="Locativo"?e.jsx(J,{}):e.jsx(Z,{});return e.jsxs("div",{draggable:!0,onDragStart:s=>l(s,r.id,d),onClick:u,className:"bg-white dark:bg-slate-800 p-4 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 cursor-pointer hover:shadow-md hover:-translate-y-0.5 transition-all mb-3 group",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsx("span",{className:`text-[10px] uppercase font-bold px-2 py-0.5 rounded border ${b[r.priority]} border-transparent`,children:r.priority}),e.jsxs("span",{className:`text-xs px-2 py-0.5 rounded font-medium bg-slate-100 dark:bg-slate-700 flex items-center gap-1 ${r.type==="Correctivo"?"text-red-600":"text-blue-600"}`,children:[a(r.type)," ",r.type]})]}),e.jsx("h4",{className:"font-bold text-slate-800 dark:text-slate-100 mb-1 leading-tight",children:r.title}),r.assetId&&e.jsxs("div",{className:"text-xs text-slate-500 dark:text-slate-400 mb-3 font-mono bg-slate-50 dark:bg-slate-900/50 px-1.5 py-0.5 rounded w-fit",children:["ID: ",r.assetId]}),e.jsxs("div",{className:"flex justify-between items-center pt-2 border-t border-slate-100 dark:border-slate-700",children:[e.jsxs("div",{className:"flex items-center gap-3 text-slate-400",children:[r.attachments.length>0&&e.jsxs("span",{className:"text-xs flex items-center gap-1",children:[e.jsx($,{})," ",r.attachments.length]}),e.jsxs("span",{className:"text-xs flex items-center gap-1",children:[e.jsx("i",{className:"far fa-calendar"})," ",r.dueDate]})]}),e.jsx("div",{className:"flex -space-x-2",children:r.assignedUsers.map(s=>e.jsx("div",{className:"w-6 h-6 rounded-full bg-slate-300 dark:bg-slate-600 border-2 border-white dark:border-slate-800 flex items-center justify-center text-[10px] font-bold text-slate-700 dark:text-slate-200",title:s.initials,children:s.initials},s.id))})]})]})},ne=({column:r,onDragStart:l,onDragOver:d,onDrop:u,onViewTask:b,onAddTask:a})=>e.jsxs("div",{className:"bg-slate-100 dark:bg-slate-800/50 rounded-xl p-3 w-80 flex-shrink-0 flex flex-col max-h-[calc(100vh-200px)]",onDragOver:d,onDrop:s=>u(s,r.id),children:[e.jsxs("div",{className:"flex justify-between items-center mb-3 px-1",children:[e.jsx("h3",{className:"font-bold text-slate-700 dark:text-slate-200",children:r.title}),e.jsx("span",{className:"text-xs font-bold bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 rounded-full px-2 py-0.5",children:r.tasks.length})]}),e.jsx("div",{className:"overflow-y-auto flex-grow pr-1",children:r.tasks.map(s=>e.jsx(le,{task:s,onDragStart:l,columnId:r.id,onClick:()=>b(s)},s.id))}),e.jsxs("button",{onClick:()=>a(r.id),className:"w-full mt-2 p-2 text-sm font-medium text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-md transition-colors flex items-center justify-center gap-2",children:[e.jsx(V,{})," Añadir Orden"]})]}),be=()=>{const{addNotification:r}=Q(),[l,d]=m.useState({}),[u,b]=m.useState(null),[a,s]=m.useState(!1),[c,g]=m.useState(!1),[y,x]=m.useState(null),[S,w]=m.useState(null),[k,E]=m.useState(!0),O=m.useRef(!1);m.useEffect(()=>{O.current||(O.current=!0,C())},[]);const C=async()=>{try{E(!0);const{data:t,error:i}=await I.from("boards").select("id").eq("type","maintenance").single();if(i||!t){console.error("Board not found:",i);return}w(t.id);const{data:p,error:j}=await I.from("board_columns").select("*").eq("board_id",t.id).order("position");if(j)throw j;let h=p||[];if(h.length===0){const N=["Solicitudes","En Proceso","Espera de Repuestos","Finalizado"];for(let A=0;A<N.length;A++){const{data:f}=await I.from("board_columns").insert({board_id:t.id,title:N[A],position:A}).select().single();f&&h.push(f)}}const _=h.map(N=>N.id),{data:T,error:L}=await I.from("board_tasks").select(`
                    *,
                    labels:task_labels(*),
                    assignedUsers:task_assignees(*),
                    checklist:task_checklists(*),
                    attachments:task_attachments(*),
                    comments:task_comments(*)
                `).in("column_id",_).order("position");if(L)throw L;const B={};h.forEach(N=>{const A=T?.filter(f=>f.column_id===N.id).map(f=>({id:f.id,title:f.title,description:f.description||"",priority:f.priority,dueDate:f.due_date,labels:f.labels||[],assignedUsers:f.assignedUsers?.map(U=>({id:U.user_id||U.id,initials:U.user_initials||"??"}))||[],checklist:f.checklist||[],attachments:f.attachments||[],comments:f.comments||[],assetId:f.asset_id,type:f.maintenance_type}))||[];B[N.id]={id:N.id,title:N.title,tasks:A}}),d(B)}catch(t){console.error(t),r({type:"error",title:"Error",message:"No se pudieron cargar los datos."})}finally{E(!1)}},D=(t,i,p)=>{t.dataTransfer.setData("taskId",i),t.dataTransfer.setData("sourceColumnId",p)},P=t=>t.preventDefault(),M=(t,i)=>{const p=t.dataTransfer.getData("taskId"),j=t.dataTransfer.getData("sourceColumnId");n(p,j,i)},n=async(t,i,p)=>{if(i===p)return;const j=l[i],h=l[p],_=j.tasks.find(T=>T.id===t);_&&(d({...l,[i]:{...j,tasks:j.tasks.filter(T=>T.id!==t)},[p]:{...h,tasks:[...h.tasks,_]}}),await I.from("board_tasks").update({column_id:p}).eq("id",t),r({type:"info",title:"Orden Movida",message:`Nueva ubicación: ${h.title}`}))},o=async t=>{const i={...l};for(const p in i){const j=i[p].tasks.findIndex(h=>h.id===t.id);if(j!==-1){i[p].tasks[j]=t;break}}d(i),await I.from("board_tasks").update({title:t.title,description:t.description,priority:t.priority,due_date:t.dueDate,asset_id:t.assetId,maintenance_type:t.type}).eq("id",t.id),r({type:"success",title:"Orden Actualizada",message:"Los cambios han sido guardados."})},v=async t=>{const i={...l};for(const p in i)i[p].tasks=i[p].tasks.filter(j=>j.id!==t);d(i),await I.from("board_tasks").delete().eq("id",t),r({type:"error",title:"Orden Eliminada",message:"El registro ha sido eliminado."})},R=async(t,i,p,j)=>{if(!y||!S)return;const{data:h}=await I.from("board_tasks").insert({column_id:y,title:t,priority:i,maintenance_type:p,asset_id:j,description:"",due_date:new Date().toISOString().split("T")[0]}).select().single();if(h){const _={id:h.id,title:h.title,priority:h.priority,type:h.maintenance_type,assetId:h.asset_id,description:h.description,dueDate:h.due_date,labels:[],assignedUsers:[],attachments:[]},T={...l};T[y].tasks.push(_),d(T)}};return k?e.jsx("div",{className:"h-full flex items-center justify-center",children:e.jsx(G,{className:"text-6xl text-slate-300 animate-bounce"})}):e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"mb-6 flex-shrink-0",children:[e.jsx(Y,{crumbs:[{label:"Mantenimiento",path:"/maintenance/board"},{label:"Tablero OTs"}]}),e.jsxs("div",{className:"flex justify-between items-end mt-2",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-slate-800 dark:text-slate-100",children:"Tablero de Mantenimiento"}),e.jsx("p",{className:"text-slate-500 dark:text-slate-400",children:"Gestión visual de órdenes de trabajo (Trello-Style)."})]}),e.jsx("div",{className:"flex gap-4",children:e.jsx(X,{tableName:"board_tasks",label:"Importar Órdenes",onUploadComplete:C,mapping:t=>{const i=Object.keys(l)[0];return!S||!i?(console.error("Board info missing for upload"),t):{column_id:i,title:t.Title||t.title||t.Titulo||"Orden Importada",description:t.Description||t.description||t.Descripcion||"",priority:t.Priority||t.priority||t.Prioridad||"Media",maintenance_type:t.Type||t.type||t.Tipo||"Correctivo",asset_id:t.AssetID||t.asset_id||t.Activo||"",due_date:t.DueDate||t.due_date||t.FechaLimite||new Date().toISOString().split("T")[0]}}})})]})]}),e.jsx("div",{className:"flex-grow overflow-x-auto",children:e.jsx("div",{className:"flex gap-6 h-full min-w-max pb-4 px-1",children:Object.values(l).map(t=>e.jsx(ne,{column:t,onDragStart:D,onDragOver:P,onDrop:M,onViewTask:i=>{b(i),s(!0)},onAddTask:i=>{x(i),g(!0)}},t.id))})}),e.jsx(ae,{isOpen:a,onClose:()=>s(!1),task:u,onSave:o,onDelete:v}),e.jsx(re,{isOpen:c,onClose:()=>g(!1),onSave:R})]})};export{be as default};
