import{j as e}from"./vendor-ui-Csmkvd-_.js";import{r as p}from"./vendor-react-B11IQRCK.js";import{a as Y,z,y as H,n as W}from"./index-CRB8BTUJ.js";import{s as f}from"./insforgeClient-BTlHhBMi.js";const X=({crumbs:m})=>e.jsx("nav",{className:"flex mb-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest",children:m.map((x,g)=>e.jsxs("span",{className:"flex items-center",children:[g>0&&e.jsx("span",{className:"mx-2 text-slate-600",children:"/"}),x.path?e.jsx("a",{href:`#${x.path}`,className:"hover:text-sky-500 transition-colors",children:x.label}):e.jsx("span",{children:x.label})]},g))});function Q(){const{addNotification:m}=Y(),[x,g]=p.useState(!1),[k,C]=p.useState([]),[U,E]=p.useState(!0),_={id:"",fechaRegistro:new Date().toISOString().split("T")[0],nombreEquipo:"",marca:"",codigo:"",areaUso:"",nombreResponsable:"",motivoReposicion:"",devuelveEquipoAnterior:"NO",descripcionBaja:"",seCobraEquipo:"NO",nombreResponsableCalidad:"",firmaResponsableArea:"",firmaResponsableCalidad:""},[t,o]=p.useState(_),[w,q]=p.useState(null),h=p.useRef(null),u=p.useRef(null),[L,R]=p.useState(!1),[P,y]=p.useState(!1),S=async()=>{E(!0);try{const{data:a,error:r}=await f.from("metrology_replacements").select("*").order("created_at",{ascending:!1});if(r)throw r;const i=(a||[]).map(s=>({id:s.id,fechaRegistro:s.fecha_registro,nombreEquipo:s.nombre_equipo,marca:s.marca,codigo:s.codigo,areaUso:s.area_uso,nombreResponsable:s.nombre_responsable,motivoReposicion:s.motivo_reposicion,devuelveEquipoAnterior:s.devuelve_equipo_anterior||"",descripcionBaja:s.descripcion_baja,seCobraEquipo:s.se_cobra_equipo||"",nombreResponsableCalidad:s.nombre_responsable_calidad,firmaResponsableArea:s.firma_responsable_area_url||"",firmaResponsableCalidad:s.firma_responsable_calidad_url||""}));C(i)}catch(a){console.error("Error fetching metrology replacements:",a),m({type:"error",title:"ERROR DE CARGA",message:"No se pudieron recuperar los registros de reposición."})}finally{E(!1)}};p.useEffect(()=>{S()},[]);const A=async(a,r)=>{if(!a||a.length<100)return"";try{const i=`rep_${r}_${Date.now()}.png`,s=await(await fetch(a)).blob(),{error:n}=await f.storage.from("signatures").upload(i,s,{contentType:"image/png"});if(n)throw n;const c=f.storage.from("signatures").getPublicUrl(i);return c.data?.publicUrl||c}catch(i){return console.error("Error uploading signature:",i),""}},D=(a,r)=>{const i=r.getBoundingClientRect(),s=r.width/i.width,n=r.height/i.height;return{x:(a.clientX-i.left)*s,y:(a.clientY-i.top)*n}},O=(a,r,i)=>{i(!0);const s=r.current?.getContext("2d");if(s&&r.current){const{x:n,y:c}=D(a,r.current);s.beginPath(),s.moveTo(n,c),s.lineWidth=2,s.lineCap="round",s.strokeStyle="#0f172a"}},I=(a,r,i)=>{if(!i)return;const s=r.current?.getContext("2d");if(s&&r.current){const{x:n,y:c}=D(a,r.current);s.lineTo(n,c),s.stroke()}},j=a=>{a(!1)},v=a=>{const r=a.current?.getContext("2d");r&&a.current&&r.clearRect(0,0,a.current.width,a.current.height)},T=()=>{o(_),q(null),g(!1),v(h),v(u)},B=a=>{const{id:r,firmaResponsableArea:i,firmaResponsableCalidad:s,...n}=a;o(a),q(r),g(!0),setTimeout(()=>{const c=(b,G)=>{if(!b)return;const $=G.current?.getContext("2d"),N=new Image;N.crossOrigin="anonymous",N.onload=()=>$?.drawImage(N,0,0),N.src=b};i&&c(i,h),s&&c(s,u)},300)},M=async a=>{a.preventDefault();try{m({type:"info",title:"PROCESANDO...",message:"Guardando registro y firmas..."});const r=h.current?.toDataURL()||"",i=u.current?.toDataURL()||"";let s=t.firmaResponsableArea||"",n=t.firmaResponsableCalidad||"";r.startsWith("data:")&&(s=await A(r,"area")),i.startsWith("data:")&&(n=await A(i,"calidad"));const c={fecha_registro:t.fechaRegistro,nombre_equipo:t.nombreEquipo,marca:t.marca,codigo:t.codigo,area_uso:t.areaUso,nombre_responsable:t.nombreResponsable,motivo_reposicion:t.motivoReposicion,devuelve_equipo_anterior:t.devuelveEquipoAnterior,descripcion_baja:t.descripcionBaja,se_cobra_equipo:t.seCobraEquipo,nombre_responsable_calidad:t.nombreResponsableCalidad,firma_responsable_area_url:s,firma_responsable_calidad_url:n};let b;if(w?b=await f.from("metrology_replacements").update(c).eq("id",w):b=await f.from("metrology_replacements").insert([c]),b.error)throw b.error;m({type:"success",title:w?"REGISTRO ACTUALIZADO":"REGISTRO GUARDADO",message:`Reposición de ${t.nombreEquipo} procesada.`}),S(),T()}catch(r){console.error("Error saving replacement:",r),m({type:"error",title:"ERROR",message:r.message})}},F=async a=>{if(confirm("¿Eliminar este registro?"))try{const{error:r}=await f.from("metrology_replacements").delete().eq("id",a);if(r)throw r;C(i=>i.filter(s=>s.id!==a)),m({type:"error",title:"REGISTRO ELIMINADO",message:"Registro eliminado de la base de datos."})}catch{m({type:"error",title:"ERROR",message:"No se pudo eliminar el registro."})}},d="w-full p-3 bg-slate-50 dark:bg-[#1a1a24] border border-slate-200 dark:border-white/5 rounded-lg text-xs font-bold text-slate-900 dark:text-white focus:ring-2 focus:ring-[#5d5fef] outline-none transition-all uppercase placeholder:text-slate-400",l="text-[9px] font-black text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-1.5 block ml-1";return e.jsxs("div",{className:"space-y-8 animate-fade-in pb-20",children:[e.jsx(X,{crumbs:[{label:"Metrología",path:"/metrology"},{label:"Reposición y Baja"}]}),e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center gap-6",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-4xl md:text-5xl font-black text-slate-800 dark:text-white uppercase tracking-tighter leading-none",children:["Reposición y ",e.jsx("span",{className:"text-sky-600",children:"Baja"})]}),e.jsx("p",{className:"text-slate-500 font-bold mt-2 uppercase text-[10px] tracking-widest italic",children:"Gestión de Ciclo de Vida de Equipos"})]}),e.jsx("button",{onClick:()=>g(!x),className:`px-8 py-4 rounded-xl text-[10px] font-black uppercase tracking-widest shadow-xl transition-all ${x?"bg-rose-500 text-white shadow-rose-500/20":"bg-sky-600 text-white shadow-sky-500/20 hover:scale-105"}`,children:x?"Cancelar":"Nueva Solicitud"})]}),x&&e.jsxs("div",{className:"bg-white dark:bg-[#0b0b14] border border-slate-200 dark:border-white/5 p-4 md:p-12 rounded-3xl shadow-2xl animate-fade-in-up",children:[e.jsx("div",{className:"flex justify-center mb-8",children:e.jsx("h2",{className:"text-lg font-black text-slate-700 dark:text-white uppercase tracking-widest border-b-2 border-slate-100 dark:border-white/10 pb-2",children:"Reposición y Baja de Equipos de Medición"})}),e.jsxs("form",{onSubmit:M,className:"space-y-8",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:l,children:"Fecha Registro *"}),e.jsx("input",{type:"date",required:!0,value:t.fechaRegistro,onChange:a=>o({...t,fechaRegistro:a.target.value}),className:d})]}),e.jsxs("div",{children:[e.jsx("label",{className:l,children:"Nombre Equipo *"}),e.jsx("input",{required:!0,value:t.nombreEquipo,onChange:a=>o({...t,nombreEquipo:a.target.value}),className:d})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:l,children:"Marca *"}),e.jsx("input",{list:"marcas-list",required:!0,value:t.marca,onChange:a=>o({...t,marca:a.target.value}),className:d}),e.jsx("datalist",{id:"marcas-list",children:z.map(a=>e.jsx("option",{value:a},a))})]}),e.jsxs("div",{children:[e.jsx("label",{className:l,children:"Código *"}),e.jsx("input",{required:!0,value:t.codigo,onChange:a=>o({...t,codigo:a.target.value}),className:d})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:l,children:"Proceso/Área de Uso *"}),e.jsxs("select",{required:!0,value:t.areaUso,onChange:a=>o({...t,areaUso:a.target.value}),className:d,children:[e.jsx("option",{value:"",children:"SELECCIONE..."}),H.map(a=>e.jsx("option",{value:a,children:a},a))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:l,children:"Nombre del Responsable *"}),e.jsx("input",{required:!0,value:t.nombreResponsable,onChange:a=>o({...t,nombreResponsable:a.target.value}),className:d})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:l,children:"Descripción Motivo de Reposición *"}),e.jsx("textarea",{required:!0,value:t.motivoReposicion,onChange:a=>o({...t,motivoReposicion:a.target.value}),className:`${d} h-24 resize-none`})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:e.jsxs("div",{children:[e.jsx("label",{className:l,children:"¿Devuelve Equipo Anterior?"}),e.jsxs("select",{value:t.devuelveEquipoAnterior,onChange:a=>o({...t,devuelveEquipoAnterior:a.target.value}),className:d,children:[e.jsx("option",{value:"",children:"Seleccione"}),e.jsx("option",{value:"SI",children:"SI"}),e.jsx("option",{value:"NO",children:"NO"})]})]})}),e.jsxs("div",{children:[e.jsx("label",{className:l,children:"Descripción Baja del Equipo y Disposición Final"}),e.jsx("textarea",{value:t.descripcionBaja,onChange:a=>o({...t,descripcionBaja:a.target.value}),className:`${d} h-24 resize-none`})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:l,children:"¿Se Cobra Equipo?"}),e.jsxs("select",{value:t.seCobraEquipo,onChange:a=>o({...t,seCobraEquipo:a.target.value}),className:d,children:[e.jsx("option",{value:"",children:"Seleccione"}),e.jsx("option",{value:"SI",children:"SI"}),e.jsx("option",{value:"NO",children:"NO"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:l,children:"Nombre Responsable Calidad *"}),e.jsx("input",{required:!0,value:t.nombreResponsableCalidad,onChange:a=>o({...t,nombreResponsableCalidad:a.target.value}),className:d})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-12 pt-8",children:[e.jsxs("div",{children:[e.jsx("label",{className:`${l} text-center mb-4`,children:"Firma Responsable Proceso/Área *"}),e.jsxs("div",{className:"border border-slate-300 dark:border-white/10 rounded-xl overflow-hidden bg-white relative h-40",children:[e.jsx("canvas",{ref:h,width:400,height:160,className:"w-full h-full cursor-crosshair touch-none",onPointerDown:a=>O(a,h,R),onPointerMove:a=>I(a,h,L),onPointerUp:()=>j(R),onPointerLeave:()=>j(R)}),e.jsxs("div",{className:"absolute inset-x-0 bottom-2 text-center pointer-events-none opacity-20",children:[e.jsx("i",{className:"fas fa-pen-nib text-4xl text-slate-400"}),e.jsx("p",{className:"text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1",children:"Sign Here"})]})]}),e.jsx("button",{type:"button",onClick:()=>v(h),className:"mt-2 text-[10px] font-bold text-sky-500 hover:text-sky-600 uppercase tracking-widest float-right",children:"Limpiar"})]}),e.jsxs("div",{children:[e.jsx("label",{className:`${l} text-center mb-4`,children:"Firma Responsable Calidad *"}),e.jsxs("div",{className:"border border-slate-300 dark:border-white/10 rounded-xl overflow-hidden bg-white relative h-40",children:[e.jsx("canvas",{ref:u,width:400,height:160,className:"w-full h-full cursor-crosshair touch-none",onPointerDown:a=>O(a,u,y),onPointerMove:a=>I(a,u,P),onPointerUp:()=>j(y),onPointerLeave:()=>j(y)}),e.jsxs("div",{className:"absolute inset-x-0 bottom-2 text-center pointer-events-none opacity-20",children:[e.jsx("i",{className:"fas fa-pen-nib text-4xl text-slate-400"}),e.jsx("p",{className:"text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1",children:"Sign Here"})]})]}),e.jsx("button",{type:"button",onClick:()=>v(u),className:"mt-2 text-[10px] font-bold text-sky-500 hover:text-sky-600 uppercase tracking-widest float-right",children:"Limpiar"})]})]}),e.jsx("div",{className:"pt-8 flex justify-center",children:e.jsxs("button",{type:"submit",className:"w-full md:w-auto px-12 py-4 bg-[#00c853] text-white font-black uppercase text-sm tracking-widest rounded-xl shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-300 flex items-center justify-center gap-3",children:[e.jsx("i",{className:"fas fa-paper-plane"}),"Enviar"]})})]})]}),e.jsxs("div",{className:"mt-12",children:[e.jsxs("h3",{className:"text-xl font-black text-slate-800 dark:text-white uppercase tracking-tighter mb-6 flex items-center gap-3",children:[e.jsx("i",{className:"fas fa-history text-slate-400"}),"Historial de Bajas y Reposiciones"]}),e.jsx("div",{className:"overflow-x-auto rounded-xl border border-slate-200 dark:border-white/5 shadow-xl",children:e.jsxs("table",{className:"w-full text-left border-collapse",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-slate-50 dark:bg-white/5 border-b border-slate-200 dark:border-white/5 text-[10px] font-black text-slate-500 dark:text-slate-400 uppercase tracking-widest",children:[e.jsx("th",{className:"p-4",children:"Fecha"}),e.jsx("th",{className:"p-4",children:"Equipo"}),e.jsx("th",{className:"p-4",children:"Responsable"}),e.jsx("th",{className:"p-4",children:"Motivo"}),e.jsx("th",{className:"p-4 text-center",children:"Acciones"})]})}),e.jsx("tbody",{className:"bg-white dark:bg-[#0b0b14] divide-y divide-slate-100 dark:divide-white/5",children:U?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"p-12 text-center text-xs font-bold text-slate-400 uppercase animate-pulse",children:"Cargando historial..."})}):k.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"p-8 text-center text-xs font-bold text-slate-400 uppercase tracking-widest",children:"No hay registros"})}):k.map(a=>e.jsxs("tr",{className:"hover:bg-slate-50 dark:hover:bg-white/5 transition-colors",children:[e.jsx("td",{className:"p-4 text-xs font-bold text-slate-600 dark:text-slate-300",children:a.fechaRegistro}),e.jsxs("td",{className:"p-4",children:[e.jsx("div",{className:"text-xs font-black text-slate-800 dark:text-white uppercase",children:a.nombreEquipo}),e.jsxs("div",{className:"text-[10px] font-bold text-slate-400",children:[a.marca," - ",a.codigo]})]}),e.jsx("td",{className:"p-4 text-xs font-bold text-slate-600 dark:text-slate-300",children:a.nombreResponsable}),e.jsx("td",{className:"p-4 text-xs text-slate-500 dark:text-slate-400 line-clamp-2 max-w-xs",children:a.motivoReposicion}),e.jsxs("td",{className:"p-4 text-center",children:[e.jsx("button",{onClick:()=>B(a),className:"text-sky-400 hover:text-sky-500 transition-colors mr-3",children:e.jsx(W,{})}),e.jsx("button",{onClick:()=>F(a.id),className:"text-rose-400 hover:text-rose-500 transition-colors",children:e.jsx("i",{className:"fas fa-trash-can"})})]})]},a.id))})]})})]})]})}export{Q as default};
